# 限流机制恢复说明

## ✅ 已恢复限流机制

### 修改内容

1. **恢复主动限流**：所有API调用都恢复为遵守Tushare官方限流规则
2. **保留限流错误检测**：仍然能够识别限流错误
3. **适当重试机制**：遇到限流错误时适当重试（最多5次），不是无限重试

---

## 🔧 技术实现

### 1. 恢复主动限流

**代码位置**: `src/data/fetcher/tushare_fetcher.py`

所有API调用方法都已恢复为：

```python
# 恢复为遵守限流规则
@safe_api_call('daily', max_retries=5, base_delay=2.0, disable_rate_limit=False)
```

**已恢复的接口**:
- ✅ `_fetch_daily_data_from_api` - 日线数据
- ✅ `_fetch_daily_basic_from_api` - 每日指标
- ✅ `_fetch_all_daily_basic` - 批量每日指标
- ✅ `_fetch_weekly_data_from_api` - 周线数据
- ✅ `_fetch_stk_factor_from_api` - 技术因子
- ✅ `_fetch_suspend_info` - 停复牌信息

### 2. 限流错误处理

**代码位置**: `src/utils/rate_limiter.py:247-310`

```python
def retry_on_error(max_retries: int = 3, base_delay: float = 1.0, 
                   retry_on_rate_limit: bool = True):
    """重试装饰器（限流错误也遵循max_retries限制）"""
    # 限流错误：适当延迟后重试（最多max_retries次）
    if is_rate_limit and retry_on_rate_limit:
        delay = min(base_delay * (2 ** min(attempt, 5)), 60.0)  # 最大60秒
        # 重试最多max_retries次，不是无限重试
```

**重试策略**:
- **限流错误**：最多重试5次，指数退避（最大延迟60秒）
- **其他错误**：最多重试5次，指数退避

---

## 📊 工作流程

### 恢复后的流程

```
1. 调用API前 → 检查限流器 → 如果达到限制，等待
2. 调用API
3. 如果遇到限流错误 → 适当重试（最多5次）
4. 如果遇到其他错误 → 正常重试（最多5次）
```

---

## ✅ 优势

### 1. 遵守官方规则

- ✅ **遵守Tushare限流规则**：按照积分等级限制调用频率
- ✅ **账号安全**：不会触发风控机制
- ✅ **不影响其他用户**：保证大多数用户调取数据的稳定性

### 2. 智能处理

- ✅ **限流错误检测**：自动识别限流错误
- ✅ **适当重试**：遇到限流错误时适当重试（处理临时波动）
- ✅ **不无限重试**：最多重试5次，避免持续超限

### 3. 稳定性

- ✅ **数据获取稳定**：遵守规则，保证数据获取的稳定性
- ✅ **避免账号风险**：不会因为违规行为导致账号被封禁

---

## 📋 限流规则（根据积分等级）

| 积分数 | 每分钟频次 | 每天总量上限 |
|--------|-----------|-------------|
| **2000以上** | 200次/分钟 | 100000次/个API/天 |
| **5000以上** | 500次/分钟 | 常规数据无上限 |
| **10000以上** | 1000次/分钟 | 常规数据无上限 |

**当前配置**：根据你的积分自动调整限流策略

---

## 🔍 日志示例

### 正常限流等待（静默）

```
# 限流等待不会输出日志（避免日志过多）
# 系统自动等待，直到可以进行下一次调用
```

### 遇到限流错误时

```
2025-12-28 23:30:15 | WARNING | _fetch_daily_data_from_api 遇到限流错误 (第1次)，2.0秒后重试: 请求过于频繁
2025-12-28 23:30:17 | WARNING | _fetch_daily_data_from_api 遇到限流错误 (第2次)，4.0秒后重试: 请求过于频繁
2025-12-28 23:30:21 | SUCCESS | _fetch_daily_data_from_api 调用成功
```

---

## 💡 使用建议

### 1. 当前配置

- ✅ **主动限流**：已恢复，遵守官方规则
- ✅ **限流错误重试**：最多5次，处理临时波动
- ✅ **其他错误重试**：最多5次，正常重试

### 2. 如果需要更高频次

**推荐方案**：升级积分等级
- **5000积分**：每分钟500次，常规数据无上限（500元/年）
- **10000积分**：每分钟1000次（1000元/年）

### 3. 优化建议

- ✅ **使用缓存**：减少API调用次数
- ✅ **批量获取**：使用批量接口提高效率
- ✅ **合理安排时间**：避免在高峰期大量调用

---

## ✅ 总结

### 已恢复的功能

1. ✅ **主动限流**：遵守Tushare官方限流规则
2. ✅ **限流错误检测**：自动识别限流错误
3. ✅ **适当重试**：遇到限流错误时适当重试（最多5次）

### 效果

- **安全性**：遵守规则，账号安全
- **稳定性**：保证数据获取的稳定性
- **合规性**：符合Tushare官方要求

---

**文档版本**: v1.0  
**创建日期**: 2025-12-28

