# 模型生命周期中的人工介入点

## 📋 概述

本文档明确标识模型开发、训练、迭代过程中需要**人工决策和介入**的关键环节，特别是：
- 正样本选择
- 数据标注
- 因子/特征选择
- 模型选择

---

## 🎯 人工介入点总览

| 环节 | 人工介入程度 | 主要决策内容 | 自动化程度 |
|------|------------|-------------|-----------|
| **正样本选择** | ⭐⭐⭐⭐⭐ | 筛选规则、阈值设定 | 规则执行自动化 |
| **数据标注** | ⭐⭐⭐ | 标注规则验证、质量检查 | 规则自动标注 |
| **因子选择** | ⭐⭐⭐⭐⭐ | 选择哪些特征/因子 | 特征提取自动化 |
| **模型选择** | ⭐⭐⭐⭐ | 算法选择、超参数调优 | 训练自动化 |
| **版本决策** | ⭐⭐⭐⭐⭐ | 升级/回滚决策 | 对比自动化 |

---

## 📝 第一部分：正样本选择

### 1.1 人工决策内容

**需要人工决定的筛选规则**:

1. **技术指标规则**
   - 连续阳线周数（当前：3周）
   - 总涨幅阈值（当前：50%）
   - 最高涨幅阈值（当前：70%）
   - 其他技术条件（如MACD、RSI等）

2. **股票筛选规则**
   - 是否剔除ST股票（当前：是）
   - 是否剔除北交所（当前：是）
   - 最小上市天数（当前：180天）
   - 其他排除规则

3. **时间范围**
   - 数据起始日期（当前：2000-01-01）
   - 数据结束日期（当前：今天）

### 1.2 配置位置

**配置文件**: `config/settings.yaml`

```yaml
data:
  sample_preparation:
    start_date: "20000101"
    end_date: null
    
    positive_criteria:
      consecutive_weeks: 3       # 👤 人工决定：连续阳线周数
      total_return_threshold: 50 # 👤 人工决定：总涨幅阈值(%)
      max_return_threshold: 70   # 👤 人工决定：最高涨幅阈值(%)
      min_listing_days: 180      # 👤 人工决定：最小上市天数
```

**代码位置**: `src/strategy/screening/positive_sample_screener.py`

### 1.3 工作流程

```
👤 人工决策
  ↓
  修改 config/settings.yaml 中的筛选条件
  ↓
🤖 自动化执行
  ↓
  python scripts/prepare_positive_samples.py
  ↓
👤 人工检查
  ↓
  查看正样本统计结果，验证筛选效果
  ↓
  如果效果不佳，调整筛选条件
```

### 1.4 检查要点

- [ ] 正样本数量是否合理（建议：1000-5000个）
- [ ] 正样本质量是否符合预期（平均涨幅、分布等）
- [ ] 筛选条件是否过于严格或宽松
- [ ] 是否需要调整阈值

---

## 📝 第二部分：数据标注

### 2.1 人工决策内容

**当前标注方式**:
- **正样本**: 通过规则自动筛选（三连阳+涨幅条件）
- **负样本**: 基于正样本特征统计自动筛选

**需要人工介入的情况**:

1. **标注规则验证**
   - 验证正样本是否真的是"牛股"
   - 检查是否有误标注的情况
   - 评估标注规则的准确性

2. **标注质量检查**
   - 抽样检查正负样本的质量
   - 识别边界案例（borderline cases）
   - 决定是否需要人工修正

3. **标注规则调整**
   - 如果发现标注错误，调整筛选规则
   - 添加新的标注规则或条件

### 2.2 工作流程

```
🤖 自动化标注
  ↓
  正样本：根据规则自动筛选
  负样本：根据统计特征自动筛选
  ↓
👤 人工验证
  ↓
  抽样检查样本质量
  查看样本统计报告
  ↓
👤 人工决策
  ↓
  如果质量不佳，调整标注规则
  或手动修正部分样本
```

### 2.3 检查要点

- [ ] 正样本是否真的符合"牛股"定义
- [ ] 负样本是否与正样本有足够区分度
- [ ] 是否有明显的标注错误
- [ ] 样本分布是否合理

---

## 📝 第三部分：因子/特征选择

### 3.1 人工决策内容

**需要人工决定使用哪些特征/因子**:

#### 当前使用的特征类别

1. **价格特征** (自动计算)
   - `close_mean`, `close_std`, `close_max`, `close_min`
   - `close_trend`
   - 👤 **人工决定**: 是否使用这些特征

2. **涨跌幅特征** (自动计算)
   - `pct_chg_mean`, `pct_chg_std`, `pct_chg_sum`
   - `positive_days`, `negative_days`
   - `max_gain`, `max_loss`
   - 👤 **人工决定**: 是否使用这些特征

3. **量比特征** (自动计算)
   - `volume_ratio_mean`, `volume_ratio_max`
   - `volume_ratio_gt_2`, `volume_ratio_gt_4`
   - 👤 **人工决定**: 是否使用这些特征，阈值如何设定

4. **MACD特征** (Tushare API或自动计算)
   - `macd_mean`, `macd_positive_days`, `macd_max`
   - 👤 **人工决定**: 是否使用MACD，使用哪些MACD指标

5. **MA特征** (自动计算)
   - `ma5_mean`, `ma10_mean`
   - `price_above_ma5`, `price_above_ma10`
   - 👤 **人工决定**: 使用哪些MA周期（5日、10日、20日等）

6. **市值特征** (Tushare API)
   - `total_mv_mean`, `circ_mv_mean`
   - 👤 **人工决定**: 是否使用市值特征

7. **动量特征** (自动计算)
   - `return_1w`, `return_2w`
   - 👤 **人工决定**: 使用哪些时间窗口

#### 可选的额外特征

8. **基本面特征** (需要人工决定是否添加)
   - 市盈率（PE）
   - 市净率（PB）
   - 营收增长率
   - 净利润增长率
   - ROE（净资产收益率）
   - 👤 **人工决定**: 是否添加基本面特征

9. **其他技术指标** (需要人工决定是否添加)
   - KDJ指标
   - OBV指标
   - 布林带
   - RSI（已有部分）
   - 👤 **人工决定**: 是否添加这些指标

### 3.2 配置位置

**代码位置**: 
- `scripts/train_xgboost_timeseries.py` - `extract_features_with_time()` 函数
- `src/models/lifecycle/trainer.py` - `_extract_features()` 方法

**特征提取逻辑**:
```python
# 在 extract_features_with_time() 函数中
# 👤 人工决定：添加或删除特征提取逻辑

# 价格特征
feature_dict['close_mean'] = sample_data['close'].mean()
# ... 其他特征

# 👤 人工决定：是否添加新特征
# feature_dict['new_feature'] = calculate_new_feature(sample_data)
```

### 3.3 工作流程

```
👤 人工决策
  ↓
  决定使用哪些特征/因子
  修改特征提取代码
  ↓
🤖 自动化执行
  ↓
  运行特征提取
  生成特征数据
  ↓
👤 人工检查
  ↓
  查看特征重要性
  分析特征与目标的相关性
  ↓
👤 人工优化
  ↓
  移除不重要特征
  添加新特征
  调整特征计算方式
```

### 3.4 检查要点

- [ ] 特征是否与预测目标相关
- [ ] 特征重要性排序是否合理
- [ ] 是否有冗余特征
- [ ] 是否需要添加新特征
- [ ] 特征工程是否引入未来信息（避免未来函数）

---

## 📝 第四部分：模型选择

### 4.1 人工决策内容

**需要人工决定的模型相关决策**:

1. **算法选择**
   - XGBoost（当前使用）
   - LightGBM
   - CatBoost
   - 神经网络
   - 集成模型
   - 👤 **人工决定**: 选择哪种算法

2. **超参数调优**
   - `n_estimators`: 树的数量（当前：100）
   - `max_depth`: 树的最大深度（当前：5）
   - `learning_rate`: 学习率（当前：0.1）
   - `subsample`: 采样比例（当前：0.8）
   - `colsample_bytree`: 特征采样比例（当前：0.8）
   - `gamma`: 最小损失减少（当前：0.1）
   - 👤 **人工决定**: 超参数值

3. **训练策略**
   - 训练/测试集划分比例（当前：80/20）
   - 是否使用时间序列划分（当前：是）
   - 交叉验证策略
   - 早停机制
   - 👤 **人工决定**: 训练策略

4. **样本处理**
   - 是否处理样本不平衡（当前：否）
   - 是否使用样本权重
   - 是否使用SMOTE过采样
   - 👤 **人工决定**: 样本处理方式

### 4.2 配置位置

**配置文件**: `config/models/{model_name}.yaml`

```yaml
model:
  type: xgboost  # 👤 人工决定：算法类型
  
model_params:
  n_estimators: 100      # 👤 人工决定：树的数量
  max_depth: 5            # 👤 人工决定：最大深度
  learning_rate: 0.1      # 👤 人工决定：学习率
  subsample: 0.8          # 👤 人工决定：采样比例
  colsample_bytree: 0.8   # 👤 人工决定：特征采样
  gamma: 0.1              # 👤 人工决定：最小损失减少

training:
  test_size: 0.2          # 👤 人工决定：测试集比例
  time_series_split: true # 👤 人工决定：是否时间序列划分
```

### 4.3 工作流程

```
👤 人工决策
  ↓
  选择算法类型
  设定超参数
  决定训练策略
  ↓
🤖 自动化执行
  ↓
  运行模型训练
  生成训练指标
  ↓
👤 人工分析
  ↓
  查看训练结果
  分析模型性能
  ↓
👤 人工优化
  ↓
  调整超参数
  尝试不同算法
  优化训练策略
```

### 4.4 检查要点

- [ ] 模型是否过拟合或欠拟合
- [ ] 训练指标是否达到预期
- [ ] 是否需要调整超参数
- [ ] 是否需要尝试其他算法
- [ ] 模型预测速度是否满足要求

---

## 📝 第五部分：版本迭代决策

### 5.1 人工决策内容

**需要人工决定的版本迭代决策**:

1. **问题分析**
   - 识别当前模型的问题
   - 分析预测错误案例
   - 确定改进方向
   - 👤 **人工决策**: 问题分析和改进方向

2. **版本规划**
   - 确定版本号（v1.1.0 / v2.0.0 / v1.0.1）
   - 规划变更内容
   - 评估变更影响
   - 👤 **人工决策**: 版本号和变更规划

3. **对比评估**
   - 对比新旧版本指标
   - 分析改进效果
   - 评估风险
   - 👤 **人工决策**: 评估结果解读

4. **升级/回滚决策**
   - 决定是否升级到新版本
   - 决定是否回滚到旧版本
   - 决定是否继续优化
   - 👤 **人工决策**: 最终决策

### 5.2 工作流程

```
👤 人工分析
  ↓
  识别问题
  确定改进方向
  ↓
👤 人工规划
  ↓
  确定版本号
  规划变更内容
  ↓
🤖 自动化执行
  ↓
  创建新版本
  训练新模型
  生成对比报告
  ↓
👤 人工评估
  ↓
  对比新旧版本
  分析改进效果
  ↓
👤 人工决策
  ↓
  升级 / 回滚 / 继续优化
```

---

## 🎯 人工介入检查清单

### 新建模型时

- [ ] **正样本选择**: 确定筛选规则和阈值
- [ ] **数据标注**: 验证标注质量
- [ ] **因子选择**: 决定使用哪些特征
- [ ] **模型选择**: 选择算法和超参数
- [ ] **训练策略**: 决定训练方式
- [ ] **评估标准**: 确定成功指标

### 迭代模型时

- [ ] **问题分析**: 识别需要改进的问题
- [ ] **改进方向**: 决定改进哪些方面（特征/参数/算法）
- [ ] **版本规划**: 确定版本号和变更内容
- [ ] **对比评估**: 分析新旧版本差异
- [ ] **升级决策**: 决定是否升级

---

## 📚 相关文档

- [模型生命周期标准化流程](MODEL_LIFECYCLE_STANDARD.md)
- [模型生命周期快速参考](MODEL_LIFECYCLE_QUICK_REFERENCE.md)
- [样本准备指南](../docs/SAMPLE_PREPARATION_GUIDE.md)
- [特征提取指南](../docs/FEATURE_EXTRACTION_GUIDE.md)

---

## 💡 最佳实践

1. **正样本选择**: 
   - 从简单规则开始，逐步优化
   - 定期检查正样本质量
   - 根据市场环境调整阈值

2. **因子选择**:
   - 基于领域知识选择初始特征
   - 使用特征重要性指导优化
   - 避免引入未来信息

3. **模型选择**:
   - 从简单模型开始（如XGBoost）
   - 逐步尝试更复杂的模型
   - 使用交叉验证评估

4. **版本迭代**:
   - 每次只改变一个方面（特征/参数/算法）
   - 详细记录变更内容
   - 充分对比评估后再决策

