# 正样本数据质量核查指南

## 📋 目录

1. [自动化质量检查](#自动化质量检查)
2. [可视化分析](#可视化分析)
3. [人工核查要点](#人工核查要点)
4. [常见问题及解决方案](#常见问题及解决方案)

---

## 🤖 自动化质量检查

### 运行质量检查工具

```bash
python scripts/check_sample_quality.py
```

### 检查项目

质量检查工具会自动执行以下检查：

#### 1. 基础统计
- ✅ 样本总数
- ✅ 股票数量
- ✅ 涨幅统计（平均值、中位数、最大最小值）
- ✅ 日期范围

#### 2. 数据完整性
- ✅ 必需字段检查（股票代码、名称、T1日期、涨幅等）
- ✅ 空值检查
- ✅ 数据类型验证

#### 3. 数据一致性
- ✅ 总涨幅 ≤ 最高涨幅（逻辑关系）
- ✅ 总涨幅 ≥ 50%（筛选条件）
- ✅ 最高涨幅 ≥ 70%（筛选条件）

#### 4. 涨幅计算验证
- ✅ 重新计算涨幅并对比
- ✅ 发现计算误差

#### 5. 异常值检测
- ✅ IQR方法检测离群值
- ✅ 极端涨幅检测（>200%）
- ✅ 边缘样本检测（接近50%阈值）

#### 6. 重复数据检查
- ✅ 完全重复记录
- ✅ 同一股票多个T1日期（应该去重）

#### 7. 日期合理性
- ✅ 未来日期检测
- ✅ 过于久远的日期
- ✅ 年份分布统计

### 质量评分

工具会给出 0-100 的质量评分：

| 评分 | 评级 | 说明 |
|------|------|------|
| 85-100 | ⭐⭐⭐⭐⭐ 优秀 | 数据质量很好，可直接使用 |
| 70-84 | ⭐⭐⭐⭐ 良好 | 存在少量问题，建议检查 |
| 60-69 | ⭐⭐⭐ 中等 | 存在一些问题，需要处理 |
| <60 | ⭐⭐ 需要改进 | 问题较多，需要仔细检查 |

---

## 📊 可视化分析

### 运行可视化工具

```bash
python scripts/visualize_sample_quality.py
```

### 可视化内容

#### 1. 样本数据展示
- 展示前20条样本数据
- 随机抽样展示

#### 2. 涨幅分布
- 总涨幅分布直方图（文本版）
- 最高涨幅分布直方图（文本版）
- 各区间样本数量统计

#### 3. 时间分布
- 年份分布统计
- 各年样本数量

#### 4. 异常值分析
- 极端高涨幅样本（>200%）
- 边缘样本（50-55%）
- 涨幅差距小的样本

#### 5. 导出报告
- 生成文本报告：`data/processed/quality_report.txt`
- 包含所有关键统计信息

---

## 👁️ 人工核查要点

### 1. 随机抽样验证

从样本中随机抽取10-20只股票，在Tushare或交易软件中手工验证：

```bash
python scripts/visualize_sample_quality.py
# 查看随机样本
```

**核查内容：**
- ✅ T1日期是否正确（第一周第一个交易日）
- ✅ 连续三周是否都是阳线
- ✅ 涨幅计算是否正确
- ✅ 是否为ST股票
- ✅ 上市时间是否超过半年

### 2. 涨幅最大样本验证

对涨幅最大的前10个样本进行重点验证：

```python
# 查看涨幅最大的样本
visualizer.show_top_returns(n=10)
```

**注意点：**
- ⚠️ 涨幅超过200%的样本要特别关注
- ⚠️ 检查是否为重组股、借壳上市等特殊情况
- ⚠️ 确认价格数据是否准确

### 3. 边缘样本验证

对接近50%阈值的样本进行验证：

```python
# 筛选50-55%的边缘样本
edge_samples = df[(df['total_return'] >= 50) & (df['total_return'] <= 55)]
```

**验证原因：**
- 可能因为舍入误差导致包含不合格样本
- 确保真实涨幅确实大于50%

### 4. 时间异常样本

检查时间分布异常的样本：

```python
# 查看最早和最晚的样本
earliest = df.nsmallest(5, 't1_date')
latest = df.nlargest(5, 't1_date')
```

**验证点：**
- 2000年之前的样本（不应该存在）
- 近期的样本（确认是否遗漏了ST标记）

### 5. 涨幅逻辑验证

检查涨幅逻辑不一致的样本：

```python
# 总涨幅与最高涨幅差距很小
small_gap = df[df['return_gap'] < 5]

# 总涨幅大于最高涨幅（错误）
invalid = df[df['total_return'] > df['max_return']]
```

### 6. 重复样本检查

确认同一股票多个样本的情况：

```python
# 找出有多个样本的股票
stock_counts = df['ts_code'].value_counts()
multi_samples = stock_counts[stock_counts > 1]
```

**验证规则：**
- 应该只保留日期最早的样本
- 确认去重逻辑是否正确执行

---

## 🔍 人工核查步骤

### 步骤1：运行自动检查

```bash
# 1. 运行质量检查
python scripts/check_sample_quality.py

# 2. 运行可视化分析
python scripts/visualize_sample_quality.py
```

### 步骤2：查看报告

查看生成的质量报告：

```bash
cat data/processed/quality_report.txt
```

### 步骤3：抽样验证

从以下几类样本中各抽取3-5个进行验证：

1. **随机样本**：代表整体质量
2. **极端涨幅**：检查异常情况
3. **边缘样本**：确保阈值准确
4. **最早/最晚**：检查时间边界

### 步骤4：交易软件验证

使用交易软件（如通达信、同花顺）或Tushare Pro验证：

```python
import tushare as ts
import pandas as pd

# 获取周K线数据
pro = ts.pro_api('your_token')
df = pro.weekly(ts_code='000001.SZ', start_date='20200101', end_date='20201231')

# 手工计算涨幅
# 检查连续三周阳线
```

### 步骤5：记录问题

如果发现问题，记录以下信息：

- 股票代码和名称
- T1日期
- 问题描述
- 实际情况
- 可能原因

### 步骤6：反馈修正

根据发现的问题：

1. 调整筛选逻辑
2. 修复计算错误
3. 更新数据源
4. 重新运行筛选

---

## ❓ 常见问题及解决方案

### Q1: 发现涨幅不满足50%/70%条件的样本

**可能原因：**
- 复权数据不一致
- 计算精度问题
- 数据源问题

**解决方案：**
```python
# 重新获取复权因子
adj_factor = dm.get_adj_factor(ts_code, start_date, end_date)

# 重新计算涨幅
# 确保使用后复权价格
```

### Q2: 发现ST股票

**可能原因：**
- ST名单不完整
- T1日期时还未ST，后来被ST

**解决方案：**
```python
# 检查T1日期时的股票状态
st_list = dm.get_st_list()
st_at_t1 = st_list[st_list['entry_dt'] <= t1_date]
```

### Q3: 发现不是三连阳的样本

**可能原因：**
- 周K线数据错误
- 判断逻辑有误
- 数据缺失

**解决方案：**
```python
# 重新获取周K线数据
weekly_data = dm.get_weekly_data(ts_code, start_date, end_date)

# 逐个检查是否为阳线
for i in range(3):
    if weekly_data.iloc[i]['close'] <= weekly_data.iloc[i]['open']:
        print(f"第{i+1}周不是阳线")
```

### Q4: 同一股票多个样本

**可能原因：**
- 去重逻辑未执行
- 存在多个符合条件的时间段

**解决方案：**
```python
# 对同一股票，只保留日期最早的
df_dedup = df.sort_values('t1_date').groupby('ts_code').first().reset_index()
```

### Q5: 涨幅计算不一致

**可能原因：**
- 使用了不同的复权方式
- 开盘价/收盘价选择错误
- 周数计算错误

**解决方案：**
```python
# 统一使用后复权价格
# 第一周开盘价 -> 第三周收盘价
total_return = (week3_close - week1_open) / week1_open * 100

# 三周内的最高价
max_return = (max_high - week1_open) / week1_open * 100
```

---

## 📝 核查检查表

### 数据完整性
- [ ] 所有必需字段都有值
- [ ] 没有空值
- [ ] 日期格式正确

### 数据准确性
- [ ] 涨幅计算正确
- [ ] 连续三周阳线验证
- [ ] ST状态验证
- [ ] 上市时间验证

### 数据一致性
- [ ] 总涨幅 ≤ 最高涨幅
- [ ] 总涨幅 ≥ 50%
- [ ] 最高涨幅 ≥ 70%

### 数据唯一性
- [ ] 没有完全重复的记录
- [ ] 每只股票只有一个样本（或有合理解释）

### 数据合理性
- [ ] 没有未来日期
- [ ] 日期在2000年之后
- [ ] 涨幅在合理范围内

---

## 🎯 核查建议

1. **初次核查**：运行全部检查，重点关注异常值
2. **定期核查**：每次重新生成数据后都要核查
3. **抽样核查**：至少验证20个样本
4. **重点核查**：对涨幅>200%的样本100%验证
5. **记录留档**：保存核查结果和发现的问题

---

## 📞 需要帮助？

如果遇到无法解决的数据质量问题：

1. 检查数据源（Tushare）是否正常
2. 查看日志文件了解详细错误
3. 对比交易软件的数据
4. 考虑调整筛选参数

---

**最后更新**: 2025-12-23
