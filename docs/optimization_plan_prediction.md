# 预测系统优化计划

## 一、问题分析

### 1.1 20250919 vs 20251225 对比

| 维度 | 20250919（4周后） | 20251225（9天后） |
|------|------------------|------------------|
| **平均收益率** | -5.93% | +3.7% |
| **胜率** | 22.4% | 61.5% |
| **概率范围** | 97.11% - 99.55% | 98.16% - 99.73% |
| **34日涨幅>50%** | 1只（已降权） | 多只（未严格处理） |
| **最佳概率区间** | 98-98.5%（+4.01%） | 待验证 |
| **最差概率区间** | ≥99%（-12.81%） | 待验证 |

### 1.2 关键发现

1. **高概率陷阱**：20250919时，概率≥99%的股票平均收益-12.81%，胜率0%
2. **中等概率优势**：98-98.5%区间表现最好（+4.01%，胜率50%）
3. **风险控制有效**：红豆股份被降权后仍下跌-17.12%，验证了风险控制价值
4. **市场环境影响**：不同市场环境下表现差异大

## 二、优化策略

### 2.1 动态概率阈值调整

**问题**：固定Top 50可能包含表现差的极高概率股票

**方案**：
- 设置概率区间：优先选择98%-99%区间
- 对≥99%的股票额外验证（结合其他指标）
- 允许扩展到97.5%-98%区间以增加样本

**实现**：
```python
def apply_dynamic_probability_filter(df_scores, min_prob=0.975, max_prob=0.99):
    """
    动态概率过滤
    - 优先选择98%-99%区间
    - 对≥99%的股票需要额外验证
    """
```

### 2.2 分级风险控制

**问题**：当前对34日涨幅>50%的降权不够严格

**方案**：
- **30-50%**：轻微降权（5%）
- **50-70%**：中等降权（15-20%）
- **70-100%**：大幅降权（30-40%）
- **>100%**：直接过滤或降权50%+

**实现**：
```python
def apply_tiered_risk_filter(df_scores):
    """
    分级风险控制
    - 根据34日涨幅程度分级处理
    """
```

### 2.3 市场环境判断

**问题**：未考虑大盘趋势对预测的影响

**方案**：
- 获取上证指数/沪深300的34日收益率
- 判断市场趋势（上涨/下跌/震荡）
- 根据市场环境调整策略：
  - **上涨趋势**：可以适当放宽风险控制
  - **下跌趋势**：严格风险控制，提高概率阈值
  - **震荡趋势**：中等风险控制

**实现**：
```python
def get_market_regime(dm, target_date):
    """
    判断市场环境
    - 计算大盘34日收益率
    - 返回：'bull'（上涨）、'bear'（下跌）、'sideways'（震荡）
    """
```

### 2.4 综合评分机制

**问题**：仅依赖模型概率，未结合多维度指标

**方案**：
- 综合评分 = 模型概率 × 风险调整系数 × 市场环境系数
- 风险调整系数：基于34日涨幅、量价关系等
- 市场环境系数：基于大盘趋势

**实现**：
```python
def calculate_composite_score(row, market_regime):
    """
    计算综合评分
    - 基础概率
    - 风险调整
    - 市场环境调整
    """
```

## 三、实施计划

### 阶段1：风险控制优化（优先级：高）

1. ✅ 实现分级风险控制
   - 修改 `apply_risk_filter` 函数
   - 支持分级降权策略
   - 测试不同阈值效果

2. ✅ 增强风险过滤
   - 对34日涨幅>70%的股票更严格处理
   - 添加量价关系验证

### 阶段2：概率阈值优化（优先级：高）

1. ✅ 实现动态概率过滤
   - 优先选择98%-99%区间
   - 对≥99%的股票额外验证
   - 允许扩展到97.5%-98%

2. ✅ 概率区间分析
   - 在输出中显示各概率区间的统计
   - 提供概率区间建议

### 阶段3：市场环境判断（优先级：中）

1. ✅ 实现市场环境判断
   - 获取大盘指数数据
   - 计算市场趋势
   - 根据趋势调整策略

2. ✅ 市场环境集成
   - 在评分时考虑市场环境
   - 输出市场环境信息

### 阶段4：综合评分机制（优先级：中）

1. ✅ 实现综合评分
   - 结合多维度指标
   - 动态调整权重

2. ✅ 回测验证
   - 使用历史数据验证
   - 对比优化前后效果

## 四、预期效果

1. **提高胜率**：从22.4%提升到40%+
2. **降低回撤**：减少极端亏损股票
3. **提升收益**：平均收益率从-5.93%提升到正值
4. **风险可控**：更好的风险控制机制

## 五、实施时间表

- **第1周**：风险控制优化 + 概率阈值优化
- **第2周**：市场环境判断 + 综合评分机制
- **第3周**：回测验证 + 参数调优
- **第4周**：文档完善 + 上线测试

