# 快速开始指南 - 正样本筛选与质量核查

## 📝 概述

本指南将带你完成正样本数据的筛选、质量检查和人工核查全流程。

---

## 🚀 第一步：运行正样本筛选

### 命令

```bash
cd /path/to/aiquant
python scripts/prepare_positive_samples.py
```

### 预期输出

```
2025-12-23 00:53:09 | INFO | 开始筛选正样本: 20000101 - 20241223
2025-12-23 00:53:09 | INFO | 获取到 5345 只有效股票

开始处理 5345 只股票...

进度: 50/5345 (0.9%) | 找到样本: 2 个 | 成功率: 100.0% | 错误: 0
进度: 100/5345 (1.9%) | 找到样本: 4 个 | 成功率: 100.0% | 错误: 0
进度: 150/5345 (2.8%) | 找到样本: 6 个 | 成功率: 100.0% | 错误: 0
...
进度: 5300/5345 (99.2%) | 找到样本: 250 个 | 成功率: 100.0% | 错误: 7

================================================================================
筛选完成统计
================================================================================
总处理股票: 5345 只
成功处理: 5345 只 (100.0%)
处理失败: 7 只 (0.1%)
找到样本: 253 个
样本股票: 119 只
================================================================================

✅ 筛选完成！共找到 253 个正样本
```

### 进度说明

| 指标 | 说明 |
|------|------|
| 进度 | 当前处理进度和百分比 |
| 找到样本 | 累计找到的正样本数量 |
| 成功率 | 成功处理股票的比例 |
| 错误 | 处理失败的股票数量 |

**更新频率**：每处理50只股票更新一次进度

---

## 🔍 第二步：自动质量检查

### 命令

```bash
python scripts/check_sample_quality.py
```

### 检查项目

#### ✅ 1. 基础统计
```
样本总数: 253
股票数量: 119
涨幅统计:
  总涨幅 - 平均: 78.5%
  总涨幅 - 中位数: 68.2%
  总涨幅 - 最小: 50.1%
  总涨幅 - 最大: 245.8%
```

#### ✅ 2. 数据完整性
```
✓ 所有必需字段都存在
✓ 没有空值
```

#### ✅ 3. 数据一致性
```
✓ 总涨幅和最高涨幅关系正确
✓ 所有样本总涨幅 >= 50%
✓ 所有样本最高涨幅 >= 70%
```

#### ✅ 4. 异常检测
```
发现 5 个总涨幅异常值（IQR方法）:
  600123.SH 某股票: 215.6%
  ...
```

#### ✅ 5. 重复检查
```
✓ 没有完全重复的记录
✓ 每只股票只有一个样本（符合去重规则）
```

### 质量评分

```
数据质量评分: 90/100
评级: 优秀 ⭐⭐⭐⭐⭐
```

---

## 📊 第三步：可视化分析

### 命令

```bash
python scripts/visualize_sample_quality.py
```

### 输出内容

#### 1. 涨幅分布

```
总涨幅分布:
  50-60%       150个 (18.0%) ████████
  60-80%       200个 (24.0%) ████████████
  80-100%      300个 (36.0%) ████████████████
  100-150%     150个 (18.0%) ████████
  150-200%      30个 (3.6%) ██
  200%+         10个 (1.2%) █
```

#### 2. 时间分布

```
年份分布:
  2000年:  5个 (0.6%) ██
  2005年: 15个 (1.8%) ███
  2010年: 25个 (3.0%) █████
  2015年: 35个 (4.2%) ███████
  2020年: 45个 (5.4%) █████████
  2024年: 20个 (2.4%) ████
```

#### 3. 涨幅最高的10个样本

```
ts_code    name      t1_date    total_return  max_return
600123.SH  某股票    2020-01-06  215.6%       268.3%
300456.SZ  某股票    2019-05-13  198.4%       245.7%
...
```

#### 4. 异常值

```
极端高涨幅样本（>200%）: 8个
边缘样本（50-55%）: 12个
涨幅差距小的样本（<5%）: 5个
```

---

## 👁️ 第四步：人工抽样核查

### 抽样策略

建议从以下几类样本中各抽取3-5个验证：

#### 1. 随机样本（代表整体质量）

```python
import pandas as pd

df = pd.read_csv('data/processed/positive_samples.csv')
random_samples = df.sample(5)
print(random_samples[['ts_code', 'name', 't1_date', 'total_return']])
```

#### 2. 极端涨幅样本（检查异常）

```python
extreme_samples = df[df['total_return'] > 200].head(5)
print(extreme_samples[['ts_code', 'name', 't1_date', 'total_return']])
```

#### 3. 边缘样本（确保阈值准确）

```python
edge_samples = df[(df['total_return'] >= 50) & (df['total_return'] <= 55)].head(5)
print(edge_samples[['ts_code', 'name', 't1_date', 'total_return']])
```

### 验证方法

对每个抽样样本，在Tushare或交易软件中验证：

```python
import tushare as ts

pro = ts.pro_api('your_token')

# 示例：验证 000001.SZ 在 2020-01-06 的样本
ts_code = '000001.SZ'
t1_date = '20200106'

# 获取周K线（后复权）
df_weekly = pro.weekly(
    ts_code=ts_code,
    start_date='20191201',
    end_date='20200131',
    adj='hfq'
)

print(df_weekly)
```

### 验证检查表

对每个样本验证：

```
样本：000001.SZ 平安银行
T1日期：2020-01-06

验证项：
[ ] 1. T1是该周的第一个交易日？
[ ] 2. 连续三周都是阳线？
[ ] 3. 总涨幅 >= 50%？
[ ] 4. 最高涨幅 >= 70%？
[ ] 5. T1时不是ST股？
[ ] 6. 上市超过半年？

验证结果：✅ 通过 / ❌ 不通过
```

---

## 📈 第五步：查看质量报告

### 命令

```bash
cat data/processed/quality_report.txt
```

### 报告内容

- 基础统计
- 前20个样本详情
- 涨幅最大的10个样本
- 时间分布
- 异常值列表

---

## ✅ 质量核查总结

### 判断标准

| 评分 | 评级 | 建议 |
|------|------|------|
| 85-100 | ⭐⭐⭐⭐⭐ | 可以直接使用 |
| 70-84 | ⭐⭐⭐⭐ | 排除问题样本后使用 |
| 60-69 | ⭐⭐⭐ | 需要清洗数据 |
| <60 | ⭐⭐ | 需要重新筛选 |

### 人工核查建议

| 总样本数 | 建议验证数 | 重点验证 |
|---------|-----------|---------|
| < 100   | 20个 (20%) | 所有涨幅>200%的样本 |
| 100-500 | 30个 (5-10%) | 所有边缘样本（50-55%） |
| 500-1000 | 50个 (5%) | 随机样本 |
| > 1000  | 100个 (~10%) | 按比例分配 |

---

## 🔧 常见问题

### Q1: 进度显示太快/太慢？

修改进度更新频率：

```python
# 在 positive_sample_screener.py 中
if (idx + 1) % 50 == 0:  # 改为 10、100 等
    log.info(...)
```

### Q2: 发现数据质量问题？

1. 记录问题样本
2. 分析问题原因
3. 修改筛选逻辑
4. 重新运行筛选
5. 重新质量检查

### Q3: 如何调整筛选条件？

修改筛选参数：

```python
# 在 prepare_positive_samples.py 中
config = {
    'min_total_return': 0.50,  # 总涨幅>=50%
    'min_max_return': 0.70,    # 最高涨幅>=70%
    'min_list_days': 180,      # 上市>=180天
    'start_date': '20000101'   # 起始日期
}
```

### Q4: 如何验证单只股票？

使用测试脚本：

```bash
python scripts/test_positive_samples.py
# 选择选项1：测试单只股票
```

---

## 📚 相关文档

- [数据质量核查指南](QUALITY_CHECK_GUIDE.md) - 详细的质量核查方法
- [数据质量工作流程](DATA_QUALITY_WORKFLOW.md) - 完整的工作流程
- [Tushare Pro功能](TUSHARE_PRO_FEATURES.md) - Tushare接口使用说明
- [运行指南](../RUN_GUIDE.md) - 详细的运行说明

---

## 🎯 核查要点总结

### ✅ 必须检查的项目

1. **数据完整性** - 无空值、无缺失字段
2. **逻辑一致性** - 涨幅关系正确
3. **阈值验证** - 满足筛选条件
4. **去重验证** - 无重复样本
5. **人工抽样** - 至少验证20个样本

### ⚠️ 重点关注的样本

1. 涨幅>200%的样本（100%验证）
2. 涨幅50-55%的边缘样本（100%验证）
3. 随机样本（按比例验证）

### 📝 记录要求

- 每次筛选记录质量评分
- 记录发现的问题和解决方案
- 保留质量报告的历史版本

---

## 💪 最佳实践

1. **首次运行**：先用小范围测试（如2020-2024）
2. **定期更新**：每月更新一次数据
3. **质量优先**：宁少勿滥，保证质量
4. **文档记录**：记录每次运行的参数和结果
5. **版本管理**：保留历史版本对比

---

**文档版本**: v1.0  
**最后更新**: 2025-12-23

