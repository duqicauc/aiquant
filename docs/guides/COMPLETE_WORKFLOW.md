# 完整工作流程 - 从数据准备到模型训练 🚀

从零开始构建选股模型的完整步骤

---

## 📋 流程总览

```
第1步: 准备正样本数据
   ↓
第2步: 准备负样本数据（V2推荐）
   ↓
第3步: 数据质量检查
   ↓
第4步: 模型训练（时间序列划分，避免未来函数）
   ↓
第5步: 模型评估与分析
   ↓
第6步: Walk-Forward验证（可选）
   ↓
第7步: 回测与实盘
```

---

## 🎯 第1步：准备正样本数据

### 执行命令

```bash
python scripts/prepare_positive_samples.py
```

### 预期时间

- **快速测试**: 运行 `python scripts/test_positive_samples.py` (30秒，10只股票)
- **完整准备**: 约30-60分钟（取决于股票数量和时间范围）

### 输出文件

```
data/processed/
├── positive_samples.csv              # 正样本列表（股票代码、T1日期）
├── feature_data_34d.csv              # 正样本特征（34天×N个样本）
└── sample_statistics.json            # 统计报告
```

### 验证

```bash
# 查看样本数量
wc -l data/processed/positive_samples.csv

# 查看数据预览
head data/processed/positive_samples.csv
```

预期输出：
```
1145 个正样本（根据数据范围不同会有变化）
```

---

## 🎯 第2步：准备负样本数据

### ⚡ 推荐：V2方案（同周期其他股票法）

```bash
python scripts/prepare_negative_samples_v2.py
```

**优点：**
- ✅ 速度快（10-30分钟）
- ✅ 数据充足
- ✅ 更接近实际场景

### 🎨 可选：V1方案（特征统计法）

```bash
python scripts/prepare_negative_samples.py
```

**优点：**
- ✅ 负样本特征与正样本相似
- ✅ 更有挑战性

**缺点：**
- ⚠️ 耗时较长（1-2小时）

### 输出文件

```
data/processed/
├── negative_samples_v2.csv           # 负样本列表
├── negative_feature_data_v2_34d.csv  # 负样本特征（label=0）
└── negative_sample_statistics_v2.json # 统计报告
```

### 验证

```bash
# 查看负样本数量
wc -l data/processed/negative_samples_v2.csv

# 确认数据文件存在
ls -lh data/processed/*_v2*
```

---

## 🎯 第3步：数据质量检查（可选但推荐）

### 执行命令

```bash
# 自动质量检查
python scripts/check_sample_quality.py

# 可视化分析
python scripts/visualize_sample_quality.py
```

### 检查内容

1. **基本统计** - 样本数、时间范围
2. **完整性检查** - 缺失值、空值
3. **一致性检查** - 数据类型、范围
4. **异常值检测** - 离群点、极端值
5. **重复检查** - 重复样本
6. **日期合理性** - T1日期是否合理
7. **收益率验证** - 正样本是否真的涨>50%

### 预期结果

```
综合评分: 92.1分
质量评级: A（优秀）

✓ 所有检查通过
```

如果有警告，根据提示修复。

---

## 🎯 第4步：模型训练（⚠️ 避免未来函数）

### ✅ 推荐：时间序列划分训练

```bash
python scripts/train_xgboost_timeseries.py
```

**关键特性：**
- ✅ 按时间排序数据
- ✅ 训练集 = 前80%时间段（如2022-2023年）
- ✅ 测试集 = 后20%时间段（如2024年）
- ✅ 确保训练集完全在测试集之前
- ✅ 避免未来函数，无数据泄露

### ❌ 不推荐：随机划分训练

```bash
# 不要用这个！会产生未来函数！
python scripts/train_xgboost.py  # ❌
```

### 预期时间

5-10分钟

### 输出文件

```
models/
└── xgboost_timeseries_v2_20241223_120000.json  # 模型文件

data/results/
└── xgboost_timeseries_v2_metrics.json          # 评估报告
```

### 输出示例

```
================================================================================
时间划分:
  训练集: 2022-01-04 至 2023-10-15
  测试集: 2023-10-16 至 2024-12-20

样本划分:
  训练集: 1832 个样本 (正:916, 负:916)
  测试集: 458 个样本 (正:229, 负:229)

✓ 训练集和测试集时间无重叠，无数据泄露风险
================================================================================

模型性能总结:
  准确率 (Accuracy):  86.03%
  精确率 (Precision): 87.27%
  召回率 (Recall):    83.84%
  F1分数 (F1-Score):  85.52%
  AUC-ROC:            0.9234

特征重要性 Top 5:
  pct_chg_sum              : 0.1423
  close_trend              : 0.1289
  volume_ratio_gt_2        : 0.0987
  positive_days            : 0.0876
  macd_positive_days       : 0.0754
```

---

## 🎯 第5步：模型评估与分析

### 查看评估报告

```bash
cat data/results/xgboost_timeseries_v2_metrics.json
```

### 关键指标解读

| 指标 | 含义 | 好的标准 |
|------|------|---------|
| **Accuracy** | 整体准确率 | > 80% |
| **Precision** | 预测为牛股的准确率 | > 80% |
| **Recall** | 真牛股被找出的比例 | > 75% |
| **F1-Score** | 综合指标 | > 80% |
| **AUC** | 分类能力 | > 0.85 |

### 特征重要性分析

查看哪些指标最重要：
```
1. pct_chg_sum (涨跌幅总和) - 最重要
2. close_trend (价格趋势)
3. volume_ratio_gt_2 (量比>2次数)
...
```

**优化方向：**
- 关注重要性高的特征
- 创造类似的衍生特征
- 删除重要性<0.01的特征

---

## 🎯 第6步：Walk-Forward验证（可选）

### 为什么需要？

单次训练测试可能有偶然性，walk-forward验证在多个时间窗口上测试模型稳定性。

### 执行（TODO：待实现）

```bash
python scripts/walk_forward_validation.py
```

### 预期输出

```
时间窗口1: 2022-01~2022-12 → 2023-01~2023-03  F1: 84.2%
时间窗口2: 2022-04~2023-03 → 2023-04~2023-06  F1: 86.1%
时间窗口3: 2022-07~2023-06 → 2023-07~2023-09  F1: 83.5%
时间窗口4: 2022-10~2023-09 → 2023-10~2023-12  F1: 85.8%

平均F1: 84.9%
标准差: 1.2%  ← 小的标准差说明模型稳定
```

---

## 🎯 第7步：回测与实盘（TODO：待实现）

### 回测

```bash
python scripts/backtest.py --model models/xgboost_timeseries_v2_*.json
```

### 实盘模拟

```bash
python scripts/paper_trading.py
```

---

## ⚠️ 关键注意事项

### 1. 避免未来函数 🚨

**必须**:
- ✅ 按时间划分训练/测试集
- ✅ 训练集完全在测试集之前
- ✅ 特征只使用T1及之前的数据

**禁止**:
- ❌ 随机划分数据
- ❌ 使用未来价格/成交量
- ❌ 全局归一化

详见：[避免未来函数指南](AVOID_FUTURE_FUNCTION.md)

### 2. 数据质量

- 定期检查数据质量
- 关注异常值和缺失值
- 验证正样本确实涨>50%

### 3. 模型监控

- 定期重新训练模型（如每月）
- 监控实盘效果与回测的差异
- 如果差异大，检查是否有未来函数

---

## 📊 完整时间估算

| 步骤 | 时间 | 说明 |
|------|------|------|
| 准备正样本 | 30-60分钟 | 首次运行，后续有缓存 |
| 准备负样本(V2) | 10-30分钟 | 推荐方案 |
| 数据质量检查 | 5分钟 | 可选 |
| 模型训练 | 5-10分钟 | 时间序列划分 |
| 评估分析 | 5分钟 | 查看报告 |
| **总计** | **55-110分钟** | 首次完整流程 |

后续迭代只需5-10分钟（如果数据已准备好）。

---

## ✅ 快速开始检查清单

### 开始前

- [ ] Python环境已配置
- [ ] 依赖包已安装 (`pip install -r requirements.txt`)
- [ ] Tushare token已配置 (`.env`文件)

### 数据准备

- [ ] 正样本数据已准备
- [ ] 负样本数据已准备（推荐V2）
- [ ] 数据质量检查通过

### 模型训练

- [ ] 使用时间序列划分脚本（`train_xgboost_timeseries.py`）
- [ ] 确认训练集和测试集时间无重叠
- [ ] 模型性能达标（F1 > 80%）

### 验证

- [ ] 特征重要性合理
- [ ] 测试集效果与训练集接近
- [ ] Walk-forward验证稳定（可选）

### 部署前

- [ ] 回测验证通过
- [ ] 纸面交易验证通过
- [ ] 确认无未来函数

---

## 🆘 常见问题

### Q1: 为什么必须按时间划分？

**A**: 避免未来函数！如果随机划分，可能用2024年数据训练、2023年数据测试，这在实际中不可能发生。结果就是回测虚高，实盘亏损。

### Q2: 训练集和测试集性能差异大怎么办？

**A**: 可能原因：
1. 过拟合 - 增加正则化、减少模型复杂度
2. 市场环境变化 - 正常，需要定期重训练
3. 未来函数 - 检查是否有数据泄露

### Q3: V1和V2负样本用哪个？

**A**: 
- **初期**: 用V2（快速）
- **优化**: 对比两者效果
- **生产**: 选择F1-Score最高的

### Q4: 多久重新训练一次模型？

**A**: 推荐：
- **月度**: 适合大多数策略
- **周度**: 如果市场变化快
- **季度**: 如果策略稳定

### Q5: 如何确认没有未来函数？

**A**:
1. 检查训练脚本使用 `train_xgboost_timeseries.py`
2. 查看日志确认时间无重叠
3. 逐个检查特征是否用了未来数据
4. 对比回测和实盘效果

---

## 📚 相关文档

| 文档 | 用途 |
|------|------|
| [避免未来函数](AVOID_FUTURE_FUNCTION.md) | ⭐ 必读 |
| [模型训练指南](MODEL_TRAINING_GUIDE.md) | 训练详解 |
| [模型选择对比](MODEL_COMPARISON.md) | 选择模型 |
| [负样本方案对比](NEGATIVE_SAMPLE_COMPARISON.md) | V1 vs V2 |
| [数据质量工作流程](DATA_QUALITY_WORKFLOW.md) | 质量保证 |

---

## 🎯 快速命令汇总

```bash
# === 完整流程（首次运行） ===

# 1. 准备正样本
python scripts/prepare_positive_samples.py

# 2. 准备负样本（V2推荐）
python scripts/prepare_negative_samples_v2.py

# 3. 数据质量检查（可选）
python scripts/check_sample_quality.py

# 4. 模型训练（时间序列划分，避免未来函数）
python scripts/train_xgboost_timeseries.py

# 5. 查看结果
cat data/results/xgboost_timeseries_v2_metrics.json

# === 后续迭代（数据已准备） ===

# 直接训练新模型
python scripts/train_xgboost_timeseries.py
```

---

**文档版本**: v1.0  
**创建时间**: 2024-12-23  
**最后更新**: 2024-12-23

**现在开始你的量化交易之旅吧！** 🚀

