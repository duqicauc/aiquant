# æ•°æ®ç¼“å­˜ä¸APIé™æµè¯´æ˜ ğŸ“¦âš¡

## æ¦‚è¿°

ä¸ºäº†æé«˜æ•ˆç‡å’Œéµå®ˆTushare Proçš„APIé™åˆ¶ï¼Œé¡¹ç›®å®ç°äº†ï¼š
1. âœ… **æœ¬åœ°æ•°æ®ç¼“å­˜** - é¿å…é‡å¤æ‹‰å–æ•°æ®
2. âœ… **APIé™æµæ§åˆ¶** - è‡ªåŠ¨æ§åˆ¶è°ƒç”¨é¢‘ç‡
3. âœ… **è‡ªåŠ¨é‡è¯•æœºåˆ¶** - ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
4. âœ… **å¢é‡æ›´æ–°** - æ™ºèƒ½å¢é‡è·å–æ–°æ•°æ®

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### ä¼˜åŒ–å‰
```python
# âŒ æ¯æ¬¡éƒ½è°ƒç”¨API
df1 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # APIè°ƒç”¨
df2 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # é‡å¤è°ƒç”¨ï¼
df3 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # åˆè°ƒç”¨ï¼

# é—®é¢˜ï¼š
# - æµªè´¹APIé…é¢
# - é€Ÿåº¦æ…¢
# - å¯èƒ½è§¦å‘é™æµ
```

### ä¼˜åŒ–å
```python
# âœ… ç¬¬ä¸€æ¬¡ä»APIè·å–ï¼Œä¹‹åä»ç¼“å­˜è¯»å–
df1 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # APIè°ƒç”¨ï¼Œå­˜å…¥ç¼“å­˜
df2 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # ä»ç¼“å­˜è¯»å–ï¼âš¡
df3 = dm.get_daily_data('600519.SH', '20200101', '20201231')  # ä»ç¼“å­˜è¯»å–ï¼âš¡

# ä¼˜åŠ¿ï¼š
# âœ… èŠ‚çœAPIé…é¢
# âœ… é€Ÿåº¦å¿«10-100å€
# âœ… è‡ªåŠ¨é™æµ
# âœ… ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
```

---

## ğŸ“¦ æœ¬åœ°æ•°æ®ç¼“å­˜

### 1. ç¼“å­˜æœºåˆ¶

#### å­˜å‚¨æ–¹å¼
ä½¿ç”¨**SQLiteæ•°æ®åº“**å­˜å‚¨ç¼“å­˜æ•°æ®ï¼š
- ä½ç½®ï¼š`data/cache/quant_data.db`
- ç±»å‹ï¼šè½»é‡çº§å…³ç³»æ•°æ®åº“
- ä¼˜åŠ¿ï¼šå¿«é€Ÿã€å¯é ã€è·¨å¹³å°

#### ç¼“å­˜çš„æ•°æ®ç±»å‹
| æ•°æ®ç±»å‹ | è¡¨å | è¯´æ˜ |
|---------|------|------|
| æ—¥çº¿æ•°æ® | daily_data | å¼€é«˜ä½æ”¶ã€æˆäº¤é‡ç­‰ |
| å‘¨çº¿æ•°æ® | weekly_data | å‘¨Kçº¿æ•°æ® |
| æ¯æ—¥æŒ‡æ ‡ | daily_basic | å¸‚å€¼ã€é‡æ¯”ã€PE/PBç­‰ |
| æŠ€æœ¯å› å­ | stk_factor | MAã€MACDã€KDJã€RSIç­‰ |

### 2. ç¼“å­˜ç­–ç•¥

#### æ™ºèƒ½ç¼“å­˜åˆ¤æ–­
```python
# ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­ï¼š
# 1. æœ¬åœ°æ˜¯å¦æœ‰æ•°æ®ï¼Ÿ
# 2. æ•°æ®æ˜¯å¦å®Œæ•´è¦†ç›–è¯·æ±‚èŒƒå›´ï¼Ÿ
# 3. æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ>24å°æ—¶ï¼‰ï¼Ÿ

# å¦‚æœéƒ½æ»¡è¶³ â†’ ä»ç¼“å­˜è¯»å–
# å¦åˆ™ â†’ ä»APIè·å–å¹¶æ›´æ–°ç¼“å­˜
```

#### å¢é‡æ›´æ–°
```python
# åœºæ™¯ï¼šå·²æœ‰2020-2022çš„æ•°æ®ï¼Œéœ€è¦2020-2024
# æ™ºèƒ½ç­–ç•¥ï¼šåªè·å–2022-2024çš„æ–°æ•°æ®ï¼Œç„¶ååˆå¹¶

# æœ¬åœ°å·²æœ‰ï¼š2020-01-01 è‡³ 2022-12-31
# è¯·æ±‚èŒƒå›´ï¼š2020-01-01 è‡³ 2024-12-31
# å®é™…è°ƒç”¨ï¼š2022-12-31 è‡³ 2024-12-31 â† åªè·å–æ–°å¢éƒ¨åˆ†ï¼
```

#### è‡ªåŠ¨è¿‡æœŸ
- æ•°æ®è¶…è¿‡**24å°æ—¶**è‡ªåŠ¨æ ‡è®°ä¸ºéœ€è¦æ›´æ–°
- é¿å…ä½¿ç”¨è¿‡æ—¶æ•°æ®
- å¯è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´

### 3. ä½¿ç”¨ç¤ºä¾‹

#### é»˜è®¤å¯ç”¨ç¼“å­˜
```python
from src.data.data_manager import DataManager

# é»˜è®¤å¯ç”¨ç¼“å­˜
dm = DataManager(source='tushare')

# ç¬¬ä¸€æ¬¡ï¼šä»APIè·å– + å­˜å…¥ç¼“å­˜
df = dm.get_daily_data('600519.SH', '20200101', '20201231')

# ç¬¬äºŒæ¬¡ï¼šä»ç¼“å­˜è¯»å–ï¼ˆç§’çº§å“åº”ï¼ï¼‰
df = dm.get_daily_data('600519.SH', '20200101', '20201231')
```

#### ç¦ç”¨ç¼“å­˜
```python
# å¦‚æœéœ€è¦å®æ—¶æ•°æ®ï¼Œå¯ä»¥ç¦ç”¨ç¼“å­˜
from src.data.fetcher.tushare_fetcher import TushareFetcher

fetcher = TushareFetcher(use_cache=False)
```

#### æ¸…é™¤ç¼“å­˜
```python
from src.data.storage.cache_manager import CacheManager

cache = CacheManager()

# æ¸…é™¤ç‰¹å®šè‚¡ç¥¨çš„ç¼“å­˜
cache.clear_cache(ts_code='600519.SH')

# æ¸…é™¤ç‰¹å®šæ•°æ®ç±»å‹
cache.clear_cache(ts_code='600519.SH', data_type='daily_data')

# æ¸…é™¤å…¨éƒ¨ç¼“å­˜
cache.clear_cache()
```

#### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
```python
cache = CacheManager()
stats = cache.get_cache_stats()

print(f"æ—¥çº¿æ•°æ®: {stats['daily_data']} æ¡")
print(f"å‘¨çº¿æ•°æ®: {stats['weekly_data']} æ¡")
print(f"ç¼“å­˜è‚¡ç¥¨: {stats['unique_stocks']} åª")
```

---

## âš¡ APIé™æµæ§åˆ¶

### 1. Tushareé™æµè§„åˆ™

æ ¹æ®[Tushareå®˜æ–¹æ–‡æ¡£](https://tushare.pro/document/1?doc_id=108)ï¼š

| ç§¯åˆ†ç­‰çº§ | æ¯åˆ†é’Ÿè°ƒç”¨æ¬¡æ•° | è¯´æ˜ |
|---------|--------------|------|
| 0ç§¯åˆ† | 5æ¬¡ | æœªæ³¨å†Œ |
| 120ç§¯åˆ† | 10æ¬¡ | åŸºç¡€ç”¨æˆ· |
| 2000ç§¯åˆ† | 20æ¬¡ | è¿›é˜¶ç”¨æˆ· |
| 5000ç§¯åˆ† | 60æ¬¡ | ä¸“ä¸šç”¨æˆ· â­ |
| 10000ç§¯åˆ†+ | 200æ¬¡ | æ——èˆ°ç”¨æˆ· |

### 2. è‡ªåŠ¨é™æµ

#### æ™ºèƒ½é™æµå™¨
```python
# ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®ç§¯åˆ†è®¾ç½®é™æµ
from src.data.fetcher.tushare_fetcher import TushareFetcher

# 5000ç§¯åˆ† â†’ æ¯åˆ†é’Ÿ60æ¬¡ï¼Œæ¯æ¬¡é—´éš”1ç§’
fetcher = TushareFetcher(points=5000)

# 10000ç§¯åˆ† â†’ æ¯åˆ†é’Ÿ200æ¬¡ï¼Œæ¯æ¬¡é—´éš”0.3ç§’
fetcher = TushareFetcher(points=10000)
```

#### é™æµç­–ç•¥
```python
# 1. è®°å½•æ¯æ¬¡è°ƒç”¨æ—¶é—´
# 2. å¦‚æœ1åˆ†é’Ÿå†…è°ƒç”¨æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œè‡ªåŠ¨ç­‰å¾…
# 3. ç¡®ä¿æ¯æ¬¡è°ƒç”¨é—´éš”ä¸å°äºæœ€å°é—´éš”

# ç¤ºä¾‹ï¼š5000ç§¯åˆ†
# - æ¯åˆ†é’Ÿ60æ¬¡
# - æœ€å°é—´éš”ï¼š60ç§’/60æ¬¡ = 1ç§’
# - å¦‚æœè°ƒç”¨å¤ªå¿«ï¼Œè‡ªåŠ¨sleep
```

#### é™æµæ—¥å¿—
```
2024-12-23 10:30:15 | INFO | é™æµå™¨å·²åˆå§‹åŒ–: 60æ¬¡/åˆ†é’Ÿ (æœ€å°é—´éš”1.00ç§’)
2024-12-23 10:30:16 | WARNING | è¾¾åˆ°é™æµé˜ˆå€¼ï¼Œç­‰å¾… 5.23ç§’...
```

### 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶

#### æŒ‡æ•°é€€é¿ç­–ç•¥
```python
# å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•
# - ç¬¬1æ¬¡å¤±è´¥ï¼šç­‰å¾…1ç§’åé‡è¯•
# - ç¬¬2æ¬¡å¤±è´¥ï¼šç­‰å¾…2ç§’åé‡è¯•
# - ç¬¬3æ¬¡å¤±è´¥ï¼šç­‰å¾…4ç§’åé‡è¯•
# - ç¬¬4æ¬¡å¤±è´¥ï¼šç­‰å¾…8ç§’åé‡è¯•
# ...æœ€å¤šé‡è¯•5æ¬¡
```

#### é‡è¯•æ—¥å¿—
```
2024-12-23 10:30:20 | WARNING | _fetch_daily_data_from_api è°ƒç”¨å¤±è´¥ (ç¬¬1æ¬¡)ï¼Œ1.0ç§’åé‡è¯•: ç½‘ç»œè¶…æ—¶
2024-12-23 10:30:21 | SUCCESS | é‡è¯•æˆåŠŸ
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### 1. ä¿®æ”¹é™æµé…ç½®

ç¼–è¾‘ `src/utils/rate_limiter.py`ï¼š

```python
class TushareRateLimiter:
    RATE_LIMITS = {
        0: 5,        # æœªæ³¨å†Œï¼šæ¯åˆ†é’Ÿ5æ¬¡
        120: 10,     # åŸºç¡€ï¼šæ¯åˆ†é’Ÿ10æ¬¡
        2000: 20,    # è¿›é˜¶ï¼šæ¯åˆ†é’Ÿ20æ¬¡
        5000: 60,    # ä¸“ä¸šï¼šæ¯åˆ†é’Ÿ60æ¬¡ â† å¯ä»¥è°ƒæ•´
        10000: 200,  # æ——èˆ°ï¼šæ¯åˆ†é’Ÿ200æ¬¡
    }
```

### 2. ä¿®æ”¹é‡è¯•é…ç½®

```python
# åœ¨fetcherä¸­ä¿®æ”¹è£…é¥°å™¨å‚æ•°
@safe_api_call(max_retries=5, base_delay=2.0)  # æœ€å¤šé‡è¯•5æ¬¡ï¼Œåˆå§‹å»¶è¿Ÿ2ç§’
def _fetch_daily_data_from_api(...):
    ...
```

### 3. ä¿®æ”¹ç¼“å­˜è¿‡æœŸæ—¶é—´

ç¼–è¾‘ `src/data/storage/cache_manager.py`ï¼š

```python
# ä¿®æ”¹has_dataæ–¹æ³•ä¸­çš„è¿‡æœŸåˆ¤æ–­
if datetime.now() - last_update_time < timedelta(days=1):  # 1å¤© â†’ å¯æ”¹ä¸ºå…¶ä»–
    return True
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼šè·å–100åªè‚¡ç¥¨2å¹´çš„æ—¥çº¿æ•°æ®

#### æ— ç¼“å­˜
```
æ€»APIè°ƒç”¨: 100æ¬¡
æ€»è€—æ—¶: ~300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
APIé…é¢æ¶ˆè€—: 100æ¬¡
```

#### æœ‰ç¼“å­˜ï¼ˆé¦–æ¬¡ï¼‰
```
æ€»APIè°ƒç”¨: 100æ¬¡
æ€»è€—æ—¶: ~300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
APIé…é¢æ¶ˆè€—: 100æ¬¡
é¢å¤–ï¼šæ•°æ®å­˜å…¥ç¼“å­˜
```

#### æœ‰ç¼“å­˜ï¼ˆç¬¬äºŒæ¬¡ï¼‰
```
æ€»APIè°ƒç”¨: 0æ¬¡ â­
æ€»è€—æ—¶: ~3ç§’ï¼ˆä»ç¼“å­˜è¯»å–ï¼‰ğŸš€
APIé…é¢æ¶ˆè€—: 0æ¬¡ â­
é€Ÿåº¦æå‡: 100å€ï¼
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡è¿è¡Œ
```python
# é¦–æ¬¡è¿è¡Œä¼šè¾ƒæ…¢ï¼ˆéœ€è¦ä¸‹è½½æ•°æ®ï¼‰
# å»ºè®®å…ˆè¿è¡Œå°èŒƒå›´æµ‹è¯•

# æµ‹è¯•ï¼šåªè·å–10åªè‚¡ç¥¨
python scripts/test_positive_samples.py

# é€šè¿‡åå†è¿è¡Œå®Œæ•´è„šæœ¬
python scripts/prepare_positive_samples.py
```

### 2. å®šæœŸæ›´æ–°
```python
# å»ºè®®æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼Œå¢é‡æ›´æ–°æ•°æ®
# ç³»ç»Ÿä¼šè‡ªåŠ¨åªè·å–æ–°å¢çš„æ•°æ®

# æ¯å¤©å®šæ—¶ä»»åŠ¡
0 9 * * * cd /path/to/project && python scripts/update_data.py
```

### 3. ç›‘æ§ç¼“å­˜
```python
# å®šæœŸæŸ¥çœ‹ç¼“å­˜å¤§å°
from src.data.storage.cache_manager import CacheManager

cache = CacheManager()
stats = cache.get_cache_stats()
print(f"ç¼“å­˜æ•°æ®é‡: {sum(stats.values())} æ¡")

# å¦‚æœç¼“å­˜è¿‡å¤§ï¼Œå¯ä»¥æ¸…ç†æ—§æ•°æ®
cache.clear_cache()
```

### 4. é”™è¯¯å¤„ç†
```python
try:
    df = dm.get_daily_data('600519.SH', '20200101')
except Exception as e:
    print(f"è·å–æ•°æ®å¤±è´¥: {e}")
    # 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
    # 2. æ£€æŸ¥Tushareç§¯åˆ†
    # 3. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç¼“å­˜æ•°æ®å­˜åœ¨å“ªé‡Œï¼Ÿ
**A**: `data/cache/quant_data.db`ï¼ˆSQLiteæ•°æ®åº“ï¼‰

### Q2: å¦‚ä½•ç¡®è®¤ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ
**A**: æŸ¥çœ‹æ—¥å¿—ï¼Œä¼šæ˜¾ç¤º"ä»ç¼“å­˜è¯»å–æ•°æ®"ï¼š
```
2024-12-23 10:30:15 | INFO | âœ“ ä»ç¼“å­˜è¯»å–æ•°æ®: 600519.SH daily_data (242æ¡)
```

### Q3: ç¼“å­˜ä¼šè‡ªåŠ¨æ›´æ–°å—ï¼Ÿ
**A**: æ˜¯çš„ï¼æ•°æ®è¶…è¿‡24å°æ—¶ä¼šè‡ªåŠ¨å¢é‡æ›´æ–°

### Q4: é™æµå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
**A**: ç³»ç»Ÿä¼šè‡ªåŠ¨ç­‰å¾…å’Œé‡è¯•ã€‚å¦‚æœæŒç»­å¤±è´¥ï¼š
1. æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•

### Q5: å¯ä»¥å®Œå…¨ç¦ç”¨é™æµå—ï¼Ÿ
**A**: ä¸å»ºè®®ã€‚è¿åé™æµè§„åˆ™å¯èƒ½å¯¼è‡´è´¦å·è¢«å°ã€‚

### Q6: ç¼“å­˜æ•°æ®åº“ä¼šå¾ˆå¤§å—ï¼Ÿ
**A**: å–å†³äºè·å–çš„æ•°æ®é‡ï¼š
- 1åªè‚¡ç¥¨1å¹´æ—¥çº¿ï¼š~1KB
- 1000åªè‚¡ç¥¨1å¹´æ—¥çº¿ï¼š~1MB
- 5000åªè‚¡ç¥¨10å¹´å…¨éƒ¨æ•°æ®ï¼š~100MB

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. âœ… **èŠ‚çœAPIé…é¢** - é¿å…é‡å¤è°ƒç”¨
2. âœ… **æå‡é€Ÿåº¦** - ç¼“å­˜è¯»å–å¿«100å€
3. âœ… **è‡ªåŠ¨é™æµ** - éµå®ˆTushareè§„åˆ™
4. âœ… **è‡ªåŠ¨é‡è¯•** - ç½‘ç»œé”™è¯¯è‡ªåŠ¨å¤„ç†
5. âœ… **å¢é‡æ›´æ–°** - æ™ºèƒ½è·å–æ–°æ•°æ®
6. âœ… **é›¶é…ç½®** - å¼€ç®±å³ç”¨

### æ¨èè®¾ç½®
- **ç§¯åˆ†**: 5000+ï¼ˆä¸“ä¸šç‰ˆï¼Œ60æ¬¡/åˆ†é’Ÿï¼‰
- **ç¼“å­˜**: å¯ç”¨ï¼ˆé»˜è®¤ï¼‰
- **é‡è¯•**: 3-5æ¬¡
- **è¿‡æœŸæ—¶é—´**: 24å°æ—¶

### ç«‹å³ä½¿ç”¨
```python
from src.data.data_manager import DataManager

# è‡ªåŠ¨å¯ç”¨ç¼“å­˜å’Œé™æµ
dm = DataManager(source='tushare')

# äº«å—é«˜é€Ÿæ•°æ®è®¿é—®ï¼
df = dm.get_daily_data('600519.SH', '20200101', '20241231')
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024-12-23  
**å‚è€ƒ**: [Tushare Proæ–‡æ¡£](https://tushare.pro/document/1?doc_id=108)

